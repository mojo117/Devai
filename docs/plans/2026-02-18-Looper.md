# Plan: Refactor CHAPO as Decision Loop + Delete Looper

**Status:** In Progress (2026-02-18)
**Branch:** dev

---

## Current Progress

| Phase | Description | Status | Notes |
|-------|-------------|--------|-------|
| 0 | Move looper utilities into agents/ | **DONE** | error-handler.ts, self-validation.ts, conversation-manager.ts, types.ts updated |
| 1 | Build agents/chapo-loop.ts | **DONE** | ~550 lines, full loop with delegation + validation |
| 2+3 | Rewire processRequest() + delete dead functions | **DONE** | `processRequest()` routed to `ChapoLoop`; removed `executeSimpleTask()`, `runChapoQualification()`, `delegateToAgent()`, `runParallelExecution()`, `handleEscalation()`, `runChapoReview()` |
| 4 | Delete all looper code | **DONE** | looper route/engine/types removed, imports/wiring cleaned |
| 5 | Rewrite architecture.md + update docs | **DONE** | architecture updated for CHAPO loop; CLAUDE/workspace docs checked |
| 6 | Push to dev + verify on Clawd | **IN PROGRESS** | Pushed to `dev` (`13e1351`), Clawd PM2 + health checks passed; manual chat scenario tests still open |

### Files Created So Far

| File | Lines | Phase |
|------|-------|-------|
| `apps/api/src/agents/error-handler.ts` | ~110 | 0 |
| `apps/api/src/agents/self-validation.ts` | ~90 | 0 |
| `apps/api/src/agents/conversation-manager.ts` | ~120 | 0 |
| `apps/api/src/agents/chapo-loop.ts` | ~550 | 1 |
| `apps/api/src/agents/types.ts` | updated | 0 |

### What's Left

1. **Phase 2+3:** Rewire `processRequest()` in router.ts to use ChapoLoop, then delete the 6 dead functions
   - Done: fast/standard split removed, loop wired, ASK/approval state persistence added in `chapo-loop.ts`
   - Done: Plan Mode task execution migrated to `ChapoLoop` (`executePlanTaskWithLoop()`)
   - Done: legacy pipeline helpers removed from router
2. **Phase 4:** Delete `looper/` directory, `routes/looper.ts`, cleanup imports in server.ts, db/queries.ts, prompts/index.ts, shared/src/index.ts, sessionLogger.ts
   - Done: deleted `apps/api/src/looper/`, `apps/api/src/routes/looper.ts`, `apps/api/src/prompts/looper-core.ts`, `shared/src/looper.ts`
   - Done: cleaned looper wiring from `server.ts`, `db/queries.ts`, `prompts/index.ts`, `shared/src/index.ts`, `sessionLogger.ts`
3. **Phase 5:** Rewrite `docs/architecture.md`, check CLAUDE.md and workspace/AGENTS.md
   - Done: architecture doc aligned with CHAPO decision loop + WebSocket-first API
   - Done: checked `CLAUDE.md` and `workspace/AGENTS.md` for looper references (none)
4. **Phase 6:** Push, verify PM2 restart, test on devai.klyde.tech
   - Done: `git push origin dev` (commit `13e1351`)
   - Done: Clawd checks (`pm2 status`, `pm2 logs devai-api-dev`, `/api/health`, preview URL)
   - Remaining: manual end-to-end scenario tests (ANSWER/TOOL/DELEGATE/ASK/error recovery)

---

## Context

The current `router.ts` has a linear pipeline (Qualify → Plan? → Execute → Review) with two separate code paths (fast/standard). Problems:
- Tool errors kill the chat — no recovery, just "Fehler aufgetreten"
- Qualification and execution are disconnected phases with duplicated tool-handling
- No self-validation before answering
- The Looper system (`looper/`) is dead code but has good patterns (error handler, self-validation, conversation manager)

**Goal:** CHAPO becomes a continuous decision loop with 4 actions. Errors feed back into the loop. Self-validation runs before answers. Looper code gets deleted. Documentation updated.

## The CHAPO Loop — 4 Actions

```
User message → CHAPO Decision Loop:
    ├── ANSWER → Self-validate, send response, exit loop
    ├── ASK → Pause loop, wait for user reply
    ├── TOOL → Execute tool, feed result back into loop
    └── DELEGATE → Run DEVO/SCOUT sub-loop, feed result back into loop

Error at any point → Feed error as context into loop → CHAPO decides next step
```

**Key insight:** No separate "decision engine" needed. The LLM's tool_calls ARE the decision. `delegateToDevo` = DELEGATE, `askUser` = ASK, `fs_readFile` = TOOL, no tool_calls = ANSWER.

---

## Phase 0: Move Looper Utilities Into `agents/` — DONE

**Goal:** Copy 3 utility classes from `looper/` into `agents/`, renamed for new context.

### Files Created

**`apps/api/src/agents/error-handler.ts`** — copied from `looper/error-handler.ts`
- Renamed `LooperError` → `AgentError`, `LooperErrorHandler` → `AgentErrorHandler`
- Removed snapshot/restore methods
- Kept: `safe()`, `canRetry()`, `resetRetry()`, `formatForLLM()`, `getErrors()`, `clear()`, `classifyError()`

**`apps/api/src/agents/self-validation.ts`** — copied from `looper/self-validation.ts`
- Updated import: `ValidationResult` from `./types.js` instead of `@devai/shared`

**`apps/api/src/agents/conversation-manager.ts`** — copied from `looper/conversation-manager.ts`
- Removed snapshot()/restore() methods

**`apps/api/src/agents/types.ts`** — added `ValidationResult` and `ChapoLoopResult` types

---

## Phase 1: Build `agents/chapo-loop.ts` — DONE

**Goal:** Create the core loop class.

### File Created

**`apps/api/src/agents/chapo-loop.ts`** (~550 lines)

```typescript
class ChapoLoop {
  private errorHandler: AgentErrorHandler;
  private validator: SelfValidator;
  private conversation: ConversationManager;

  async run(userMessage, conversationHistory): Promise<ChapoLoopResult>
  private async runLoop(userMessage): Promise<ChapoLoopResult>
  private async delegateToDevo(task, context): Promise<string>  // max 10 turns
  private async delegateToScout(query, scope): Promise<string>  // max 5 turns
  private async handleAnswer(userMessage, answer): Promise<ChapoLoopResult>
}
```

**Error handling:** Every tool call and LLM call wrapped in `errorHandler.safe()`. Errors formatted and fed back as tool results. CHAPO sees errors and decides: retry, ask user, or answer with error context.

**Self-validation:** Advisory only — runs before ANSWER, logs issues, always delivers the answer.

---

## Phase 2+3: Rewire `processRequest()` + Delete Dead Functions — DONE

**Goal:** Replace the fast/standard path split with ChapoLoop, then delete replaced functions.

### File to EDIT

**`apps/api/src/agents/router.ts`** (currently 2234 lines → target ~1400)

#### Step 1: Rewire processRequest()

**Signature stays identical.** Quick-exit logic stays identical (yes/no, pending approvals, small talk, remember).

Replace the fast/standard path split (~lines 267-420) with:

```typescript
// Pre-loop gate: plan mode for complex tasks (unchanged behavior)
if (taskComplexity === 'complex') {
  // existing plan mode logic stays
}

// Everything else goes through the loop
const loop = new ChapoLoop(sessionId, sendEvent, projectRoot, modelSelection, {
  selfValidationEnabled: taskComplexity !== 'trivial',
  maxIterations: taskComplexity === 'trivial' ? 8 : 20,
});
const result = await loop.run(userMessage, conversationHistory);
```

#### Step 2: Delete dead functions

| Function | Lines | Replaced by |
|----------|-------|-------------|
| `executeSimpleTask()` | 444-676 | `ChapoLoop.run()` (**deleted**) |
| `runChapoQualification()` | 681-955 | Still used for complex-task pre-loop plan gate |
| `delegateToAgent()` | 960-1170 | Still used by `executePlan()` (Plan Mode) |
| `runParallelExecution()` | 1175-1184 | Was just a wrapper (**deleted**) |
| `handleEscalation()` | 1189-1266 | Still used by `delegateToAgent()` |
| `runChapoReview()` | 1271-1324 | Self-validation replaces review (**deleted**) |

#### Functions that STAY

- `processRequest()` (thin wrapper)
- `handleUserResponse()`, `handleUserApproval()`
- All Plan Mode functions: `determinePlanModeRequired()`, `getChapoPerspective()`, `getDevoPerspective()`, `synthesizePlan()`, `runPlanMode()`, `executePlan()`, `handlePlanApproval()`, `getCurrentPlan()`, `getTasks()`
- `spawnScout()`, `delegateToScout()`, `parseScoutResult()`
- Helper functions (lines 68-171): `parseYesNo()`, `isSmallTalk()`, `extractExplicitRememberNote()`, etc.
- `getAgent()`, `getToolsForAgent()`, `canAgentUseTool()`

---

## Phase 4: Delete Looper Code — DONE

**Goal:** Remove all looper-related code, routes, types, DB queries.

### Files to DELETE

| File/Directory | What |
|----------------|------|
| `apps/api/src/looper/` | Entire directory |
| `apps/api/src/routes/looper.ts` | HTTP route |
| `apps/api/src/prompts/looper-core.ts` | Looper core prompt |
| `shared/src/looper.ts` | Shared looper types |

### Files to EDIT

| File | Change |
|------|--------|
| `apps/api/src/server.ts` | Remove looperRoutes import (line 14) + registration (line 78) |
| `shared/src/index.ts` | Remove `export * from './looper.js';` (line 5) |
| `apps/api/src/db/queries.ts` | Remove lines 426-490 (looper persistence) |
| `apps/api/src/prompts/index.ts` | Remove looper prompt exports (lines 7-8, 12-15). Keep VALIDATION_SYSTEM_PROMPT, multi-agent prompts, MEMORY_BEHAVIOR_BLOCK |
| `apps/api/src/audit/sessionLogger.ts` | Remove `logLooperEvent()` (lines 158-225) + LooperStreamEvent import |

### Post-deletion checks
- `grep -r 'from.*looper' apps/api/src/`
- `grep -r 'LooperStreamEvent\|LooperConfig\|LooperEngine' .`

---

## Phase 5: Update Documentation — TODO

**Goal:** Rewrite architecture.md, check CLAUDE.md and workspace docs.

### Files to REWRITE

**`docs/architecture.md`** (686 lines → rewrite)

1. Overview: "Looper-AI with 4 Sub-Agents" → "CHAPO Decision Loop with DEVO + SCOUT"
2. New architecture diagram with 4 actions
3. Remove: Decision Engine, Looper Sub-Agents, old Decision Routing
4. Add: ChapoLoop section (ANSWER, ASK, TOOL, DELEGATE)
5. Update agents: CHAPO (coordinator), DEVO (developer+devops), SCOUT (explorer)
6. Error handling: errors feed back into loop
7. Self-validation: advisory, pre-ANSWER
8. Update project structure tree (remove looper/, add new agents/ files)
9. API: primary is /api/ws/chat (WebSocket), remove POST /api/looper
10. Streaming: AgentStreamEvent via WebSocket
11. Request flow: ChapoLoop diagram
12. Frontend: WebSocket chat

### Files to CHECK

- `CLAUDE.md` — looper references?
- `workspace/AGENTS.md` — looper references?

---

## Phase 6: Push + Verify on Clawd — IN PROGRESS

1. TypeScript check on Clawd: `ssh root@10.0.0.5 "cd /opt/Devai && npx tsc --noEmit"`
2. Push to dev branch
3. Check PM2 restart: `ssh root@10.0.0.5 "pm2 status"`
4. Check startup logs: `ssh root@10.0.0.5 "pm2 logs devai-api-dev --lines 20 --nostream"`
5. Test via devai.klyde.tech:
   - ANSWER: "Hallo, wie geht's?"
   - TOOL: "Zeig mir package.json"
   - DELEGATE: "Fix the typo in README.md"
   - Error recovery: trigger tool error
   - ASK: vague request
6. Check session logs: `ssh root@10.0.0.5 "ls -la /opt/Devai/var/logs/ | tail -5"`

---

## Critical Files Summary

| File | Action | Phase | Status |
|------|--------|-------|--------|
| `agents/error-handler.ts` | NEW | 0 | Done |
| `agents/self-validation.ts` | NEW | 0 | Done |
| `agents/conversation-manager.ts` | NEW | 0 | Done |
| `agents/types.ts` | EDIT | 0 | Done |
| `agents/chapo-loop.ts` | NEW + EDIT (~550 lines) | 1 / 2+3 | Done |
| `agents/router.ts` | REFACTOR | 2+3 | Done |
| `server.ts` | EDIT | 4 | Done |
| `db/queries.ts` | EDIT | 4 | Done |
| `prompts/index.ts` | EDIT | 4 | Done |
| `sessionLogger.ts` | EDIT | 4 | Done |
| `shared/src/index.ts` | EDIT | 4 | Done |
| `shared/src/looper.ts` | DELETE | 4 | Done |
| `looper/` | DELETE | 4 | Done |
| `routes/looper.ts` | DELETE | 4 | Done |
| `prompts/looper-core.ts` | DELETE | 4 | Done |
| `docs/architecture.md` | REWRITE | 5 | Done |

## Rollback Strategy

- Phases 0-1 are purely additive (nothing breaks)
- Phase 2 is the critical switch — if it fails, revert `processRequest()` and the old pipeline still works
- Phases 3-4 are cleanup after Phase 2 is proven stable
- Phase 5 is documentation only (no runtime impact)
